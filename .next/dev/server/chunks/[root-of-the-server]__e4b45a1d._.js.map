{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/Gandhi/app/api/price-search/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(request: NextRequest) {\n  const API_TOKEN = process.env.PRICES_API_KEY;\n  \n  // Debug log (remove after testing)\n  console.log('API Token exists:', !!API_TOKEN);\n  console.log('API Token length:', API_TOKEN?.length);\n  \n  if (!API_TOKEN) {\n    return NextResponse.json(\n      { success: false, error: 'API key not configured. Check your .env.local file and restart the server.' },\n      { status: 500 }\n    );\n  }\n\n  try {\n    const { query } = await request.json();\n\n    if (!query) {\n      return NextResponse.json(\n        { success: false, error: 'Search query is required' },\n        { status: 400 }\n      );\n    }\n\n    // Step 1: Create bulk job\n    const formData = new URLSearchParams();\n    formData.append('token', API_TOKEN);\n    formData.append('source', 'google-shopping');\n    formData.append('country', 'in');\n    formData.append('key', 'keyword');\n    formData.append('values', query);\n    formData.append('completeness', 'all_pages');\n\n    const createResponse = await fetch('https://api.priceapi.com/jobs', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded',\n      },\n      body: formData.toString()\n    });\n\n    const createData = await createResponse.json();\n    \n    if (!createData.job_id) {\n      return NextResponse.json(\n        { success: false, error: createData.reason || 'Failed to create job' },\n        { status: 400 }\n      );\n    }\n\n    const jobId = createData.job_id;\n\n    // Step 2: Poll for completion\n    let jobStatus = 'new';\n    let attempts = 0;\n    const maxAttempts = 60;\n\n    while (jobStatus !== 'finished' && attempts < maxAttempts) {\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      \n      const statusResponse = await fetch(\n        `https://api.priceapi.com/jobs/${jobId}?token=${API_TOKEN}`\n      );\n      \n      const statusData = await statusResponse.json();\n      jobStatus = statusData.status;\n      attempts++;\n    }\n\n    if (jobStatus !== 'finished') {\n      return NextResponse.json(\n        { success: false, error: 'Search timed out' },\n        { status: 408 }\n      );\n    }\n\n    // Step 3: Get results\n    const resultsResponse = await fetch(\n      `https://api.priceapi.com/products/bulk/${jobId}?token=${API_TOKEN}`\n    );\n\n    const resultsData = await resultsResponse.json();\n    \n    if (!resultsData.products || resultsData.products.length === 0) {\n      return NextResponse.json(\n        { success: false, error: 'No results found' },\n        { status: 404 }\n      );\n    }\n\n    const product = resultsData.products[0];\n    \n    if (!product.success) {\n      return NextResponse.json(\n        { success: false, error: product.reason || 'Product not found' },\n        { status: 404 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      product: product\n    });\n\n  } catch (error: any) {\n    console.error('Price search error:', error);\n    return NextResponse.json(\n      { success: false, error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n} "],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,OAAoB;IAC7C,MAAM,YAAY,QAAQ,GAAG,CAAC,cAAc;IAE5C,mCAAmC;IACnC,QAAQ,GAAG,CAAC,qBAAqB,CAAC,CAAC;IACnC,QAAQ,GAAG,CAAC,qBAAqB,WAAW;IAE5C,IAAI,CAAC,WAAW;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA6E,GACtG;YAAE,QAAQ;QAAI;IAElB;IAEA,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEpC,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAA2B,GACpD;gBAAE,QAAQ;YAAI;QAElB;QAEA,0BAA0B;QAC1B,MAAM,WAAW,IAAI;QACrB,SAAS,MAAM,CAAC,SAAS;QACzB,SAAS,MAAM,CAAC,UAAU;QAC1B,SAAS,MAAM,CAAC,WAAW;QAC3B,SAAS,MAAM,CAAC,OAAO;QACvB,SAAS,MAAM,CAAC,UAAU;QAC1B,SAAS,MAAM,CAAC,gBAAgB;QAEhC,MAAM,iBAAiB,MAAM,MAAM,iCAAiC;YAClE,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,SAAS,QAAQ;QACzB;QAEA,MAAM,aAAa,MAAM,eAAe,IAAI;QAE5C,IAAI,CAAC,WAAW,MAAM,EAAE;YACtB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO,WAAW,MAAM,IAAI;YAAuB,GACrE;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,WAAW,MAAM;QAE/B,8BAA8B;QAC9B,IAAI,YAAY;QAChB,IAAI,WAAW;QACf,MAAM,cAAc;QAEpB,MAAO,cAAc,cAAc,WAAW,YAAa;YACzD,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;YAEjD,MAAM,iBAAiB,MAAM,MAC3B,CAAC,8BAA8B,EAAE,MAAM,OAAO,EAAE,WAAW;YAG7D,MAAM,aAAa,MAAM,eAAe,IAAI;YAC5C,YAAY,WAAW,MAAM;YAC7B;QACF;QAEA,IAAI,cAAc,YAAY;YAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAAmB,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,sBAAsB;QACtB,MAAM,kBAAkB,MAAM,MAC5B,CAAC,uCAAuC,EAAE,MAAM,OAAO,EAAE,WAAW;QAGtE,MAAM,cAAc,MAAM,gBAAgB,IAAI;QAE9C,IAAI,CAAC,YAAY,QAAQ,IAAI,YAAY,QAAQ,CAAC,MAAM,KAAK,GAAG;YAC9D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAAmB,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,UAAU,YAAY,QAAQ,CAAC,EAAE;QAEvC,IAAI,CAAC,QAAQ,OAAO,EAAE;YACpB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO,QAAQ,MAAM,IAAI;YAAoB,GAC/D;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;QACX;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO,IAAI;QAAwB,GAClE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}