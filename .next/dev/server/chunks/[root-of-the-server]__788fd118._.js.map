{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/Gandhi/app/api/chat/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport Groq from 'groq-sdk';\nimport { NextRequest, NextResponse } from 'next/server';\n\n// Initialize clients with error checking\nfunction getSupabaseClient() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  \n  if (!url || !key) {\n    throw new Error('Supabase credentials not configured');\n  }\n  \n  return createClient(url, key);\n}\n\nfunction getGroqClient() {\n  const apiKey = process.env.GROQ_API_KEY;\n  \n  if (!apiKey) {\n    throw new Error('Groq API key not configured');\n  }\n  \n  return new Groq({ apiKey });\n}\n\ninterface ChatMessage {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n}\n\ninterface ChatRequest {\n  chatId?: string;\n  message: string;\n  chatName?: string;\n}\n\ninterface ChatResponse {\n  success: boolean;\n  chatId: string;\n  userMessageId: string;\n  aiMessageId: string;\n  aiMessage: string;\n  context: string;\n}\n\nasync function handleChatMessage(request: ChatRequest): Promise<ChatResponse> {\n  const supabase = getSupabaseClient();\n  const groq = getGroqClient();\n  \n  let chatId: string = request.chatId || '';\n  let chatName = request.chatName || `Financial Chat ${new Date().toLocaleDateString('en-IN')}`;\n  let existingContext = '';\n\n  if (!chatId) {\n    const { data: newChat, error: chatError } = await supabase\n      .from('chats')\n      .insert({\n        name: chatName,\n        context: 'New financial wisdom conversation started.'\n      })\n      .select()\n      .single();\n\n    if (chatError || !newChat) throw new Error(`Failed to create chat: ${chatError?.message}`);\n    chatId = newChat.id;\n    existingContext = newChat.context || '';\n  } else {\n    const { data: existingChat, error: fetchError } = await supabase\n      .from('chats')\n      .select('context, name')\n      .eq('id', chatId)\n      .single();\n\n    if (fetchError) throw new Error(`Failed to fetch chat: ${fetchError.message}`);\n    existingContext = existingChat.context || '';\n    chatName = existingChat.name;\n  }\n\n  const { data: userMessageData, error: userMsgError } = await supabase\n    .from('messages')\n    .insert({\n      chat_id: chatId,\n      role: 'user',\n      content: request.message\n    })\n    .select()\n    .single();\n\n  if (userMsgError) throw new Error(`Failed to save user message: ${userMsgError.message}`);\n\n  const { data: previousMessages, error: historyError } = await supabase\n    .from('messages')\n    .select('role, content')\n    .eq('chat_id', chatId)\n    .order('created_at', { ascending: true })\n    .limit(10);\n\n  if (historyError) throw new Error(`Failed to fetch message history: ${historyError.message}`);\n\n  const conversationHistory: ChatMessage[] = previousMessages.map(msg => ({\n    role: msg.role as 'user' | 'assistant' | 'system',\n    content: msg.content\n  }));\n\n  const systemPrompt = `You are a wise financial advisor inspired by Mahatma Gandhi's principles of simplicity, frugality, and mindful living. Guide users on spending wisely, saving prudently, and living within their means.\n\nPrevious Context: ${existingContext}\n\nYou must respond with ONLY a valid JSON object in this exact format:\n{\n  \"message\": \"Your Gandhi-inspired financial advice message here\",\n  \"context\": \"Brief summary of this conversation for future reference\"\n}\n\nThe message should be warm, philosophical yet practical. The context should summarize what was discussed and any key financial topics mentioned.`;\n\n  const completion = await groq.chat.completions.create({\n    messages: [\n      { role: 'system', content: systemPrompt },\n      ...conversationHistory\n    ],\n    model: 'llama-3.3-70b-versatile',\n    temperature: 0.7,\n    max_tokens: 1024,\n    response_format: { type: 'json_object' }\n  });\n\n  const aiResponseText = completion.choices[0]?.message?.content || '{\"message\":\"Spend wisely, dear friend.\",\"context\":\"General financial discussion.\"}';\n  \n  let aiResponse;\n  try {\n    aiResponse = JSON.parse(aiResponseText);\n  } catch (e) {\n    aiResponse = {\n      message: 'Dear friend, the path to financial wisdom begins with spending wisely and living simply.',\n      context: 'User seeking financial guidance on wise spending and budgeting.'\n    };\n  }\n\n  const { data: aiMessageData, error: aiMsgError } = await supabase\n    .from('messages')\n    .insert({\n      chat_id: chatId,\n      role: 'assistant',\n      content: aiResponse.message\n    })\n    .select()\n    .single();\n\n  if (aiMsgError) throw new Error(`Failed to save AI message: ${aiMsgError.message}`);\n\n  const updatedContext = `${existingContext}\\n${aiResponse.context}`;\n\n  const { error: updateError } = await supabase\n    .from('chats')\n    .update({ context: updatedContext })\n    .eq('id', chatId);\n\n  if (updateError) throw new Error(`Failed to update context: ${updateError.message}`);\n\n  return {\n    success: true,\n    chatId,\n    userMessageId: userMessageData.id,\n    aiMessageId: aiMessageData.id,\n    aiMessage: aiResponse.message,\n    context: aiResponse.context\n  };\n}\n\nasync function getChatHistory(chatId: string) {\n  const supabase = getSupabaseClient();\n  \n  const { data: chat, error: chatError } = await supabase\n    .from('chats')\n    .select('*')\n    .eq('id', chatId)\n    .single();\n\n  if (chatError) throw new Error(`Failed to fetch chat: ${chatError.message}`);\n\n  const { data: messages, error: messagesError } = await supabase\n    .from('messages')\n    .select('*')\n    .eq('chat_id', chatId)\n    .order('created_at', { ascending: true });\n\n  if (messagesError) throw new Error(`Failed to fetch messages: ${messagesError.message}`);\n\n  return {\n    success: true,\n    chat,\n    messages\n  };\n}\n\nasync function getAllChats() {\n  const supabase = getSupabaseClient();\n  \n  const { data: chats, error } = await supabase\n    .from('chats')\n    .select('id, name, created_at')\n    .order('created_at', { ascending: false });\n\n  if (error) throw new Error(`Failed to fetch chats: ${error.message}`);\n\n  return {\n    success: true,\n    chats\n  };\n}\n\n// Next.js API Route Handlers\nexport async function POST(req: NextRequest) {\n  try {\n    const body: ChatRequest = await req.json();\n    \n    // Validate request\n    if (!body.message || typeof body.message !== 'string') {\n      return NextResponse.json(\n        { success: false, error: 'Message is required' },\n        { status: 400 }\n      );\n    }\n    \n    const result = await handleChatMessage(body);\n    return NextResponse.json(result);\n  } catch (error: any) {\n    console.error('Chat API Error:', error);\n    \n    // More specific error messages\n    let errorMessage = 'Internal server error';\n    let statusCode = 500;\n    \n    if (error.message?.includes('Supabase credentials')) {\n      errorMessage = 'Database configuration error';\n    } else if (error.message?.includes('Groq API key')) {\n      errorMessage = 'AI service configuration error';\n    } else if (error.message?.includes('Failed to')) {\n      errorMessage = error.message;\n    } else if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {\n      errorMessage = 'Connection error';\n    }\n    \n    return NextResponse.json(\n      { success: false, error: errorMessage },\n      { status: statusCode }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}