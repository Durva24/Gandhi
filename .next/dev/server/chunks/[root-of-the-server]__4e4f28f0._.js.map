{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/Gandhi/app/api/chat/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { NextRequest, NextResponse } from 'next/server';\nimport OpenAI from 'openai';\n\n// Initialize Supabase client\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n);\n\n// Initialize Neysa client via PipeShift (OpenAI-compatible)\nconst neysa = new OpenAI({\n  baseURL: 'https://api.pipeshift.com/api/v0/',\n  apiKey: process.env.NEYSA_GROQ_API_KEY!\n});\n\ninterface Message {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n}\n\ninterface AIResponse {\n  response: string;\n  context: string;\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const { chatId, message } = await req.json();\n\n    if (!message || typeof message !== 'string') {\n      return NextResponse.json(\n        { error: 'Message is required' },\n        { status: 400 }\n      );\n    }\n\n    let activeChatId = chatId;\n    let chatContext = '';\n    let chatHistory: Message[] = [];\n\n    // If no chatId provided, create a new chat\n    if (!activeChatId) {\n      const { data: newChat, error: chatError } = await supabase\n        .from('chats')\n        .insert({\n          name: `Chat ${new Date().toLocaleDateString('en-GB')}`,\n          context: 'New financial conversation started.'\n        })\n        .select()\n        .single();\n\n      if (chatError) {\n        console.error('Error creating chat:', chatError);\n        return NextResponse.json(\n          { error: 'Failed to create chat' },\n          { status: 500 }\n        );\n      }\n\n      activeChatId = newChat.id;\n      chatContext = newChat.context;\n    } else {\n      // Fetch existing chat and its context\n      const { data: chat, error: chatError } = await supabase\n        .from('chats')\n        .select('context')\n        .eq('id', activeChatId)\n        .single();\n\n      if (chatError) {\n        console.error('Error fetching chat:', chatError);\n        return NextResponse.json(\n          { error: 'Chat not found' },\n          { status: 404 }\n        );\n      }\n\n      chatContext = chat.context || '';\n\n      // Fetch conversation history (last 10 messages for context)\n      const { data: messages, error: messagesError } = await supabase\n        .from('messages')\n        .select('role, content')\n        .eq('chat_id', activeChatId)\n        .order('created_at', { ascending: true })\n        .limit(10);\n\n      if (messagesError) {\n        console.error('Error fetching messages:', messagesError);\n      } else if (messages) {\n        chatHistory = messages as Message[];\n      }\n    }\n\n    // Save user message to database\n    const { error: userMsgError } = await supabase\n      .from('messages')\n      .insert({\n        chat_id: activeChatId,\n        role: 'user',\n        content: message\n      });\n\n    if (userMsgError) {\n      console.error('Error saving user message:', userMsgError);\n      return NextResponse.json(\n        { error: 'Failed to save message' },\n        { status: 500 }\n      );\n    }\n\n    // Build messages array for Neysa API with JSON mode instruction\n    const systemPrompt = `You are an expert financial advisor focused on Gandhi's principles of simplicity, mindful spending, and financial wisdom. Your role is to provide practical financial guidance grounded in values of:\n- Simplicity and living within means\n- Mindful consumption and avoiding waste\n- Long-term financial security over short-term gains\n- Ethical and responsible money management\n- Self-reliance and financial independence\n\nCurrent conversation context: ${chatContext}\n\nYou must respond in JSON format with exactly this structure:\n{\n  \"response\": \"your helpful financial advice and guidance to the user\",\n  \"context\": \"a brief 1-2 sentence summary of what this financial conversation is about\"\n}\n\nProvide thoughtful financial wisdom and update the context based on the conversation.`;\n\n    const apiMessages: Message[] = [\n      {\n        role: 'system',\n        content: systemPrompt\n      },\n      ...chatHistory,\n      {\n        role: 'user',\n        content: message\n      }\n    ];\n\n    // Get AI response using Neysa (PipeShift) API\n    const completion = await neysa.chat.completions.create({\n      model: 'neysa-qwen3-vl-30b-a3b',\n      messages: apiMessages,\n      max_tokens: 5000,\n      temperature: 0.6,\n      response_format: { type: 'json_object' }\n    });\n\n    const aiResponseText = completion.choices[0]?.message?.content || '{\"response\": \"Sorry, I could not generate a response.\", \"context\": \"Error occurred\"}';\n    \n    // Parse JSON response\n    let parsedResponse: AIResponse;\n    try {\n      parsedResponse = JSON.parse(aiResponseText);\n    } catch (parseError) {\n      console.error('Error parsing AI response:', parseError);\n      parsedResponse = {\n        response: 'Sorry, I could not generate a proper response.',\n        context: chatContext\n      };\n    }\n\n    const { response: aiResponse, context: updatedContext } = parsedResponse;\n\n    // Save AI response to database\n    const { error: aiMsgError } = await supabase\n      .from('messages')\n      .insert({\n        chat_id: activeChatId,\n        role: 'assistant',\n        content: aiResponse\n      });\n\n    if (aiMsgError) {\n      console.error('Error saving AI message:', aiMsgError);\n      return NextResponse.json(\n        { error: 'Failed to save AI response' },\n        { status: 500 }\n      );\n    }\n\n    // Update chat context\n    const { error: updateError } = await supabase\n      .from('chats')\n      .update({ context: updatedContext })\n      .eq('id', activeChatId);\n\n    if (updateError) {\n      console.error('Error updating context:', updateError);\n    }\n\n    return NextResponse.json({\n      chatId: activeChatId,\n      message: aiResponse,\n      context: updatedContext\n    });\n\n  } catch (error) {\n    console.error('Error in chat API:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// GET endpoint to fetch chat history\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const chatId = searchParams.get('chatId');\n\n    if (!chatId) {\n      // Return all chats\n      const { data: chats, error } = await supabase\n        .from('chats')\n        .select('*')\n        .order('created_at', { ascending: false });\n\n      if (error) {\n        console.error('Error fetching chats:', error);\n        return NextResponse.json(\n          { error: 'Failed to fetch chats' },\n          { status: 500 }\n        );\n      }\n\n      return NextResponse.json({ chats });\n    }\n\n    // Fetch specific chat with messages\n    const { data: chat, error: chatError } = await supabase\n      .from('chats')\n      .select('*')\n      .eq('id', chatId)\n      .single();\n\n    if (chatError) {\n      console.error('Error fetching chat:', chatError);\n      return NextResponse.json(\n        { error: 'Chat not found' },\n        { status: 404 }\n      );\n    }\n\n    const { data: messages, error: messagesError } = await supabase\n      .from('messages')\n      .select('*')\n      .eq('chat_id', chatId)\n      .order('created_at', { ascending: true });\n\n    if (messagesError) {\n      console.error('Error fetching messages:', messagesError);\n      return NextResponse.json(\n        { error: 'Failed to fetch messages' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      chat,\n      messages\n    });\n\n  } catch (error) {\n    console.error('Error in chat API GET:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"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"}}]
}