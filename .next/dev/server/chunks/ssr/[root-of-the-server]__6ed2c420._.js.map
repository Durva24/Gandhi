{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 14, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/Gandhi/app/chat/page.tsx"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { NextRequest, NextResponse } from 'next/server';\nimport OpenAI from 'openai';\nimport { getFinancialContext } from './context';\n\n// Initialize Supabase client\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n);\n\n// Initialize Neysa client via PipeShift (OpenAI-compatible)\nconst neysa = new OpenAI({\n  baseURL: 'https://api.pipeshift.com/api/v0/',\n  apiKey: process.env.NEYSA_GROQ_API_KEY!\n});\n\ninterface Message {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const { chatId, message } = await req.json();\n\n    if (!message || typeof message !== 'string') {\n      return NextResponse.json(\n        { error: 'Message is required' },\n        { status: 400 }\n      );\n    }\n\n    let activeChatId = chatId;\n    let chatHistory: Message[] = [];\n\n    // Get user's financial data from context\n    const financialData = await getFinancialContext();\n\n    // If no chatId provided, create a new chat\n    if (!activeChatId) {\n      const { data: newChat, error: chatError } = await supabase\n        .from('chats')\n        .insert({\n          name: `Financial Chat ${new Date().toLocaleDateString('en-GB')}`,\n          context: 'New conversation with financial advisor'\n        })\n        .select()\n        .single();\n\n      if (chatError) {\n        console.error('Error creating chat:', chatError);\n        return NextResponse.json(\n          { error: 'Failed to create chat' },\n          { status: 500 }\n        );\n      }\n\n      activeChatId = newChat.id;\n    } else {\n      // Fetch conversation history (last 15 messages for better context)\n      const { data: messages, error: messagesError } = await supabase\n        .from('messages')\n        .select('role, content')\n        .eq('chat_id', activeChatId)\n        .order('created_at', { ascending: true })\n        .limit(15);\n\n      if (messagesError) {\n        console.error('Error fetching messages:', messagesError);\n      } else if (messages) {\n        chatHistory = messages as Message[];\n      }\n    }\n\n    // Save user message to database\n    const { error: userMsgError } = await supabase\n      .from('messages')\n      .insert({\n        chat_id: activeChatId,\n        role: 'user',\n        content: message\n      });\n\n    if (userMsgError) {\n      console.error('Error saving user message:', userMsgError);\n      return NextResponse.json(\n        { error: 'Failed to save message' },\n        { status: 500 }\n      );\n    }\n\n    // Build concise system prompt with Gandhi's essence\n    const systemPrompt = `You are Gandhi, a wise friend giving financial advice. Speak naturally and warmly.\n\nCRITICAL: Reply in the SAME LANGUAGE the user writes in. If they write in Hindi, reply in Hindi. If English, reply in English. If mixed, match their style.\n\nYOUR FINANCIAL DATA:\n${JSON.stringify(financialData, null, 2)}\n\nGANDHI'S MONEY WISDOM:\n- Live simply, save wisely\n- Avoid debt like poison\n- Needs before wants\n- Financial freedom = true freedom\n\nRESPONSE STYLE:\n- Answer ONLY what is asked - nothing extra\n- Keep it SHORT (2-3 sentences max)\n- Use their specific numbers when relevant\n- Be warm but direct - no lectures, no extra advice unless asked\n- Add occasional natural expressions: \"beta\", \"my friend\"\n- If they ask one thing, answer only that one thing\n\nExample: \nUser: \"How much should I save?\" \nReply: \"Beta, save at least 30% of your income. With your ₹50,000 salary, that's ₹15,000 monthly.\"\n\nNOT: \"Beta, save at least 30% of your income. With your ₹50,000 salary, that's ₹15,000 monthly. Also reduce dining expenses, build emergency fund, invest in mutual funds...\" ❌\n\nAnswer ONLY the question asked. REPLY IN THEIR LANGUAGE.`;\n\n    const apiMessages: Message[] = [\n      {\n        role: 'system',\n        content: systemPrompt\n      },\n      ...chatHistory,\n      {\n        role: 'user',\n        content: message\n      }\n    ];\n\n    // Get AI response using Neysa API\n    const completion = await neysa.chat.completions.create({\n      model: 'neysa-qwen3-vl-30b-a3b',\n      messages: apiMessages,\n      max_tokens: 500, // Reduced for shorter responses\n      temperature: 0.8,\n      top_p: 0.9,\n      frequency_penalty: 0.5, // Higher to avoid repetition\n      presence_penalty: 0.3\n    });\n\n    const aiResponse = completion.choices[0]?.message?.content || \n      'My friend, something went wrong. Ask again?';\n\n    // Save AI response to database\n    const { error: aiMsgError } = await supabase\n      .from('messages')\n      .insert({\n        chat_id: activeChatId,\n        role: 'assistant',\n        content: aiResponse\n      });\n\n    if (aiMsgError) {\n      console.error('Error saving AI message:', aiMsgError);\n      return NextResponse.json(\n        { error: 'Failed to save AI response' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      chatId: activeChatId,\n      message: aiResponse\n    });\n\n  } catch (error) {\n    console.error('Error in chat API:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// GET endpoint to fetch chat history\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const chatId = searchParams.get('chatId');\n\n    if (!chatId) {\n      // Return all chats\n      const { data: chats, error } = await supabase\n        .from('chats')\n        .select('*')\n        .order('created_at', { ascending: false });\n\n      if (error) {\n        console.error('Error fetching chats:', error);\n        return NextResponse.json(\n          { error: 'Failed to fetch chats' },\n          { status: 500 }\n        );\n      }\n\n      return NextResponse.json({ chats });\n    }\n\n    // Fetch specific chat with messages\n    const { data: chat, error: chatError } = await supabase\n      .from('chats')\n      .select('*')\n      .eq('id', chatId)\n      .single();\n\n    if (chatError) {\n      console.error('Error fetching chat:', chatError);\n      return NextResponse.json(\n        { error: 'Chat not found' },\n        { status: 404 }\n      );\n    }\n\n    const { data: messages, error: messagesError } = await supabase\n      .from('messages')\n      .select('*')\n      .eq('chat_id', chatId)\n      .order('created_at', { ascending: true });\n\n    if (messagesError) {\n      console.error('Error fetching messages:', messagesError);\n      return NextResponse.json(\n        { error: 'Failed to fetch messages' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      chat,\n      messages\n    });\n\n  } catch (error) {\n    console.error('Error in chat API GET:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"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"}}]
}